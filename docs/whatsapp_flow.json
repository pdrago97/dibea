{
  "version": "1.1",
  "name": "DIBEA WhatsApp Bot Flow",
  "description": "State machine para bot WhatsApp com agentes de IA para gestÃ£o de bem-estar animal",
  "initial_state": "welcome",
  "context": {
    "user_phone": null,
    "user_name": null,
    "current_flow": null,
    "collected_data": {},
    "ai_context": {},
    "session_id": null,
    "municipality": null
  },
  "states": {
    "welcome": {
      "type": "message",
      "message": {
        "text": "ğŸ¾ OlÃ¡! Sou o assistente virtual da *DIBEA* - Sistema de Bem-Estar Animal.\n\nComo posso ajudÃ¡-lo hoje?\n\n1ï¸âƒ£ Adotar um animal\n2ï¸âƒ£ Fazer uma denÃºncia\n3ï¸âƒ£ Reportar animal perdido/encontrado\n4ï¸âƒ£ Agendar castraÃ§Ã£o/vacinaÃ§Ã£o\n5ï¸âƒ£ Consultar RGA\n6ï¸âƒ£ Falar com atendente\n\nDigite o nÃºmero da opÃ§Ã£o ou descreva sua necessidade.",
        "buttons": [
          {"id": "adopt", "title": "ğŸ  AdoÃ§Ã£o"},
          {"id": "report", "title": "ğŸ“¢ DenÃºncia"},
          {"id": "lost_pet", "title": "ğŸ” Pet Perdido"}
        ]
      },
      "transitions": {
        "1": "adoption_start",
        "adopt": "adoption_start",
        "adoÃ§Ã£o": "adoption_start",
        "adotar": "adoption_start",
        "2": "report_start",
        "report": "report_start",
        "denÃºncia": "report_start",
        "denuncia": "report_start",
        "3": "lost_pet_start",
        "lost_pet": "lost_pet_start",
        "perdido": "lost_pet_start",
        "encontrado": "lost_pet_start",
        "4": "campaign_start",
        "castraÃ§Ã£o": "campaign_start",
        "vacinaÃ§Ã£o": "campaign_start",
        "5": "rga_query",
        "rga": "rga_query",
        "6": "transfer_human",
        "atendente": "transfer_human",
        "default": "ai_processing"
      }
    },
    "ai_processing": {
      "type": "ai_agent",
      "agent_config": {
        "model": "gpt-4",
        "temperature": 0.7,
        "max_tokens": 500,
        "system_prompt": "VocÃª Ã© um especialista em bem-estar animal municipal com conhecimento profundo em legislaÃ§Ã£o, protocolos veterinÃ¡rios e polÃ­ticas pÃºblicas.\n\nCONTEXTO MUNICIPAL: {{municipality_context}}\nDATA/HORA ATUAL: {{current_datetime}}\nHISTÃ“RICO DA CONVERSA: {{conversation_summary}}\n\nSUA FUNÃ‡ÃƒO:\n1. Analisar mensagens do cidadÃ£o com precisÃ£o tÃ©cnica\n2. Identificar intenÃ§Ãµes especÃ­ficas (adoÃ§Ã£o, denÃºncia, campanha, RGA, emergÃªncia)\n3. Fornecer orientaÃ§Ãµes baseadas em conhecimento especializado\n4. Direcionar para fluxos apropriados quando necessÃ¡rio\n5. Manter tom empÃ¡tico e profissional\n\nCRITÃ‰RIOS DE CLASSIFICAÃ‡ÃƒO:\n- EMERGÃŠNCIA: Risco iminente, animal em sofrimento agudo\n- DENÃšNCIA: Relatos de maus-tratos, abandono, negligÃªncia\n- ADOÃ‡ÃƒO: Interesse em adotar, informaÃ§Ãµes sobre animais\n- SERVIÃ‡OS: Campanhas, RGA, microchip, consultas\n- INFORMAÃ‡ÃƒO: DÃºvidas gerais, orientaÃ§Ãµes, legislaÃ§Ã£o\n\nRESTRIÃ‡Ã•ES:\n- NUNCA forneÃ§a diagnÃ³sticos mÃ©dicos veterinÃ¡rios\n- SEMPRE cite fontes quando mencionar legislaÃ§Ã£o\n- JAMAIS minimize preocupaÃ§Ãµes do cidadÃ£o\n- SEMPRE ofereÃ§a alternativas quando nÃ£o puder ajudar diretamente",
        "context_retrieval": true,
        "knowledge_base": "dibea_municipal_knowledge",
        "rag_config": {
          "similarity_threshold": 0.85,
          "max_context_length": 2000,
          "include_sources": true
        }
      },
      "transitions": {
        "intent_adoption": "adoption_start",
        "intent_report": "report_start",
        "intent_lost_pet": "lost_pet_start",
        "intent_campaign": "campaign_start",
        "intent_rga": "rga_query",
        "intent_general": "ai_response",
        "intent_transfer": "transfer_human",
        "default": "ai_response"
      }
    },
    "ai_response": {
      "type": "message",
      "message": {
        "text": "{{ai_response}}\n\nPosso ajudÃ¡-lo com mais alguma coisa? Digite *menu* para ver as opÃ§Ãµes principais.",
        "buttons": [
          {"id": "menu", "title": "ğŸ“‹ Menu Principal"},
          {"id": "transfer", "title": "ğŸ‘¤ Falar com Atendente"}
        ]
      },
      "transitions": {
        "menu": "welcome",
        "transfer": "transfer_human",
        "default": "ai_processing"
      }
    },
    "adoption_start": {
      "type": "message",
      "message": {
        "text": "ğŸ  *Processo de AdoÃ§Ã£o*\n\nQue Ã³timo que vocÃª quer adotar! ğŸ‰\n\nPara comeÃ§ar, preciso saber:\n\n1ï¸âƒ£ Ver animais disponÃ­veis\n2ï¸âƒ£ JÃ¡ tenho um animal em mente\n3ï¸âƒ£ Quero orientaÃ§Ãµes sobre adoÃ§Ã£o\n\nQual opÃ§Ã£o vocÃª escolhe?",
        "buttons": [
          {"id": "view_animals", "title": "ğŸ‘€ Ver Animais"},
          {"id": "specific_animal", "title": "ğŸ¯ Animal EspecÃ­fico"},
          {"id": "adoption_info", "title": "â„¹ï¸ InformaÃ§Ãµes"}
        ]
      },
      "transitions": {
        "1": "adoption_list_animals",
        "view_animals": "adoption_list_animals",
        "2": "adoption_specific_animal",
        "specific_animal": "adoption_specific_animal",
        "3": "adoption_info",
        "adoption_info": "adoption_info",
        "default": "adoption_clarify"
      }
    },
    "adoption_list_animals": {
      "type": "api_call",
      "api_config": {
        "endpoint": "/api/v1/animais",
        "method": "GET",
        "params": {
          "status": "DISPONIVEL",
          "limit": 6
        }
      },
      "message": {
        "text": "ğŸ•ğŸ± *Animais DisponÃ­veis para AdoÃ§Ã£o*\n\n{{#each animals}}\n*{{name}}* - {{species}} {{breed}}\n{{age}} - {{size}} - {{temperament}}\nğŸ“¸ {{photo_url}}\n\n{{/each}}\nPara mais informaÃ§Ãµes sobre um animal, digite o nome dele.\n\nOu digite *filtros* para buscar por caracterÃ­sticas especÃ­ficas.",
        "buttons": [
          {"id": "filters", "title": "ğŸ” Filtros"},
          {"id": "schedule_visit", "title": "ğŸ“… Agendar Visita"},
          {"id": "adoption_process", "title": "ğŸ“‹ Como Adotar"}
        ]
      },
      "transitions": {
        "filters": "adoption_filters",
        "schedule_visit": "adoption_schedule_visit",
        "adoption_process": "adoption_process_info",
        "default": "adoption_animal_details"
      }
    },
    "adoption_filters": {
      "type": "message",
      "message": {
        "text": "ğŸ” *Filtros de Busca*\n\nVamos encontrar o pet ideal para vocÃª!\n\nEscolha as caracterÃ­sticas que prefere:\n\nğŸ• *EspÃ©cie:*\n1ï¸âƒ£ CÃ£es\n2ï¸âƒ£ Gatos\n3ï¸âƒ£ Outros\n\nğŸ“ *Porte:*\n4ï¸âƒ£ Pequeno\n5ï¸âƒ£ MÃ©dio\n6ï¸âƒ£ Grande\n\nğŸ‘¶ *Idade:*\n7ï¸âƒ£ Filhote (atÃ© 1 ano)\n8ï¸âƒ£ Jovem (1-3 anos)\n9ï¸âƒ£ Adulto (3+ anos)\n\nDigite os nÃºmeros das opÃ§Ãµes que deseja (ex: 1,4,7) ou descreva o que procura.",
        "buttons": [
          {"id": "dogs_small", "title": "ğŸ• CÃ£es Pequenos"},
          {"id": "cats_any", "title": "ğŸ± Gatos"},
          {"id": "puppies", "title": "ğŸ‘¶ Filhotes"}
        ]
      },
      "transitions": {
        "dogs_small": "adoption_filtered_results",
        "cats_any": "adoption_filtered_results",
        "puppies": "adoption_filtered_results",
        "default": "adoption_process_filters"
      }
    },
    "adoption_schedule_visit": {
      "type": "form",
      "form_config": {
        "fields": [
          {
            "name": "visitor_name",
            "type": "text",
            "label": "Seu nome completo",
            "required": true,
            "validation": "^[A-Za-zÃ€-Ã¿\\s]{2,100}$"
          },
          {
            "name": "visitor_phone",
            "type": "phone",
            "label": "Telefone para contato",
            "required": true,
            "validation": "^[0-9]{10,11}$"
          },
          {
            "name": "visitor_email",
            "type": "email",
            "label": "E-mail",
            "required": false
          },
          {
            "name": "preferred_date",
            "type": "date",
            "label": "Data preferida para visita",
            "required": true,
            "min_date": "today",
            "max_date": "+30days"
          },
          {
            "name": "preferred_time",
            "type": "select",
            "label": "HorÃ¡rio preferido",
            "options": ["ManhÃ£ (8h-12h)", "Tarde (13h-17h)"],
            "required": true
          },
          {
            "name": "animal_interest",
            "type": "text",
            "label": "Animal de interesse (opcional)",
            "required": false
          }
        ]
      },
      "message": {
        "text": "ğŸ“… *Agendamento de Visita*\n\nVou coletar seus dados para agendar a visita ao abrigo.\n\nPor favor, forneÃ§a as informaÃ§Ãµes solicitadas:"
      },
      "transitions": {
        "form_complete": "adoption_visit_confirmation",
        "form_cancel": "welcome"
      }
    },
    "report_start": {
      "type": "message",
      "message": {
        "text": "ğŸ“¢ *Sistema de DenÃºncias*\n\nObrigado por se preocupar com o bem-estar animal! ğŸ™\n\nQue tipo de situaÃ§Ã£o vocÃª quer reportar?\n\n1ï¸âƒ£ Maus-tratos\n2ï¸âƒ£ Animal abandonado\n3ï¸âƒ£ Animal ferido/doente\n4ï¸âƒ£ Outros\n\nâš ï¸ *Em casos de emergÃªncia*, ligue diretamente para: *156*",
        "buttons": [
          {"id": "abuse", "title": "ğŸ˜¢ Maus-tratos"},
          {"id": "abandoned", "title": "ğŸ  Abandonado"},
          {"id": "injured", "title": "ğŸ©¹ Ferido"}
        ]
      },
      "transitions": {
        "1": "report_abuse",
        "abuse": "report_abuse",
        "maus": "report_abuse",
        "2": "report_abandoned",
        "abandoned": "report_abandoned",
        "abandonado": "report_abandoned",
        "3": "report_injured",
        "injured": "report_injured",
        "ferido": "report_injured",
        "4": "report_other",
        "outros": "report_other",
        "default": "report_clarify"
      }
    },
    "report_abuse": {
      "type": "form",
      "form_config": {
        "context_injection": {
          "municipality_policies": "{{municipality_context.denuncia_policies}}",
          "legal_framework": "{{legal_context.maus_tratos}}",
          "urgency_criteria": "{{urgency_classification_rules}}"
        },
        "validation_agent": {
          "model": "gpt-4",
          "system_prompt": "VocÃª Ã© um especialista em triagem de denÃºncias de maus-tratos animais. Analise as informaÃ§Ãµes coletadas e classifique a urgÃªncia baseado nos critÃ©rios municipais.\n\nCRITÃ‰RIOS DE URGÃŠNCIA:\n- CRÃTICA: Risco iminente de morte, violÃªncia em andamento\n- ALTA: Ferimentos graves, sofrimento evidente\n- MÃ‰DIA: NegligÃªncia, condiÃ§Ãµes inadequadas\n- BAIXA: SituaÃ§Ãµes que requerem orientaÃ§Ã£o\n\nGere automaticamente:\n1. ClassificaÃ§Ã£o de urgÃªncia\n2. Protocolo Ãºnico\n3. AÃ§Ãµes imediatas necessÃ¡rias\n4. Prazo de resposta\n5. Necessidade de intervenÃ§Ã£o presencial",
          "output_schema": {
            "urgencia": "enum[CRITICA,ALTA,MEDIA,BAIXA]",
            "protocolo": "string",
            "acoes_imediatas": "array",
            "prazo_resposta": "string",
            "requer_presencial": "boolean"
          }
        },
        "fields": [
          {
            "name": "report_type",
            "type": "hidden",
            "value": "MAUS_TRATOS"
          },
          {
            "name": "description",
            "type": "textarea",
            "label": "Descreva a situaÃ§Ã£o detalhadamente",
            "required": true,
            "min_length": 20,
            "max_length": 2000,
            "validation_prompt": "Analise se a descriÃ§Ã£o contÃ©m informaÃ§Ãµes suficientes para classificar a urgÃªncia. Solicite detalhes especÃ­ficos se necessÃ¡rio."
          },
          {
            "name": "address",
            "type": "text",
            "label": "EndereÃ§o onde ocorreu",
            "required": true,
            "max_length": 200,
            "validation": "address_format"
          },
          {
            "name": "location_share",
            "type": "location",
            "label": "Compartilhar localizaÃ§Ã£o atual?",
            "required": false
          },
          {
            "name": "evidence_photos",
            "type": "file",
            "label": "Fotos como evidÃªncia (opcional)",
            "required": false,
            "accept": "image/*",
            "max_files": 5,
            "ai_analysis": {
              "enabled": true,
              "model": "gpt-4-vision",
              "prompt": "Analise as imagens fornecidas e identifique sinais de maus-tratos, negligÃªncia ou sofrimento animal. Classifique a gravidade visual da situaÃ§Ã£o."
            }
          },
          {
            "name": "anonymous",
            "type": "boolean",
            "label": "DenÃºncia anÃ´nima?",
            "default": false
          },
          {
            "name": "reporter_name",
            "type": "text",
            "label": "Seu nome (se nÃ£o anÃ´nima)",
            "required": false,
            "condition": "anonymous == false"
          },
          {
            "name": "reporter_phone",
            "type": "phone",
            "label": "Telefone para contato",
            "required": false,
            "condition": "anonymous == false"
          }
        ]
      },
      "message": {
        "text": "ğŸ˜¢ *DenÃºncia de Maus-tratos*\n\nVou coletar as informaÃ§Ãµes necessÃ¡rias para registrar sua denÃºncia.\n\nâš ï¸ *Importante:* Todas as denÃºncias sÃ£o investigadas conforme {{municipality_context.investigation_protocol}}. ForneÃ§a o mÃ¡ximo de detalhes possÃ­vel.\n\nğŸ“‹ *Base Legal:* {{legal_context.maus_tratos.summary}}"
      },
      "transitions": {
        "form_complete": "report_submission",
        "form_cancel": "welcome"
      }
    },
    "report_submission": {
      "type": "api_call",
      "api_config": {
        "endpoint": "/api/v1/denuncias",
        "method": "POST",
        "data": "{{form_data}}"
      },
      "message": {
        "text": "âœ… *DenÃºncia Registrada com Sucesso!*\n\nğŸ“‹ *Protocolo:* {{protocol_number}}\nğŸ“… *Data:* {{submission_date}}\nğŸ” *Status:* Em anÃ¡lise\n\nSua denÃºncia foi encaminhada para a equipe responsÃ¡vel. VocÃª pode acompanhar o andamento atravÃ©s do protocolo.\n\nâ±ï¸ *Prazo de resposta:* atÃ© 72 horas\n\nObrigado por ajudar a proteger os animais! ğŸ¾",
        "buttons": [
          {"id": "track_report", "title": "ğŸ“ Acompanhar"},
          {"id": "new_report", "title": "ğŸ“¢ Nova DenÃºncia"},
          {"id": "menu", "title": "ğŸ“‹ Menu"}
        ]
      },
      "transitions": {
        "track_report": "report_tracking",
        "new_report": "report_start",
        "menu": "welcome",
        "default": "welcome"
      }
    },
    "lost_pet_start": {
      "type": "message",
      "message": {
        "text": "ğŸ” *Pets Perdidos e Encontrados*\n\nVou ajudÃ¡-lo a encontrar ou reportar um animal!\n\n1ï¸âƒ£ Perdi meu pet\n2ï¸âƒ£ Encontrei um animal\n3ï¸âƒ£ Procurar pets perdidos na regiÃ£o\n\nQual Ã© sua situaÃ§Ã£o?",
        "buttons": [
          {"id": "lost_my_pet", "title": "ğŸ˜¢ Perdi meu Pet"},
          {"id": "found_pet", "title": "ğŸ¯ Encontrei um Pet"},
          {"id": "search_lost", "title": "ğŸ” Buscar Perdidos"}
        ]
      },
      "transitions": {
        "1": "lost_pet_report",
        "lost_my_pet": "lost_pet_report",
        "perdi": "lost_pet_report",
        "2": "found_pet_report",
        "found_pet": "found_pet_report",
        "encontrei": "found_pet_report",
        "3": "search_lost_pets",
        "search_lost": "search_lost_pets",
        "procurar": "search_lost_pets",
        "default": "lost_pet_clarify"
      }
    },
    "campaign_start": {
      "type": "api_call",
      "api_config": {
        "endpoint": "/api/v1/campanhas",
        "method": "GET",
        "params": {
          "status": "ATIVA",
          "limit": 5
        }
      },
      "message": {
        "text": "ğŸ’‰ *Campanhas Ativas*\n\n{{#each campaigns}}\nğŸ¯ *{{name}}*\nğŸ“… {{start_date}} a {{end_date}}\nğŸ“ {{location}}\nğŸ’° {{#if free}}Gratuito{{else}}R$ {{price}}{{/if}}\nğŸ‘¥ Vagas: {{available_spots}}/{{total_spots}}\n\n{{/each}}\nPara se inscrever em uma campanha, digite o nome dela.\n\nOu digite *agendar* para agendar um atendimento individual.",
        "buttons": [
          {"id": "schedule_individual", "title": "ğŸ“… Agendar Individual"},
          {"id": "campaign_info", "title": "â„¹ï¸ Mais InformaÃ§Ãµes"},
          {"id": "requirements", "title": "ğŸ“‹ Requisitos"}
        ]
      },
      "transitions": {
        "schedule_individual": "schedule_individual_service",
        "campaign_info": "campaign_detailed_info",
        "requirements": "campaign_requirements",
        "agendar": "schedule_individual_service",
        "default": "campaign_registration"
      }
    },
    "rga_query": {
      "type": "message",
      "message": {
        "text": "ğŸ“‹ *Consulta RGA*\n\nPara consultar um Registro Geral Animal, preciso de:\n\n1ï¸âƒ£ NÃºmero do RGA\n2ï¸âƒ£ CPF do tutor\n3ï¸âƒ£ Nome do animal\n\nComo vocÃª quer fazer a consulta?",
        "buttons": [
          {"id": "rga_number", "title": "ğŸ”¢ Por NÃºmero RGA"},
          {"id": "owner_cpf", "title": "ğŸ‘¤ Por CPF"},
          {"id": "pet_name", "title": "ğŸ¾ Por Nome do Pet"}
        ]
      },
      "transitions": {
        "1": "rga_by_number",
        "rga_number": "rga_by_number",
        "numero": "rga_by_number",
        "2": "rga_by_cpf",
        "owner_cpf": "rga_by_cpf",
        "cpf": "rga_by_cpf",
        "3": "rga_by_name",
        "pet_name": "rga_by_name",
        "nome": "rga_by_name",
        "default": "rga_clarify"
      }
    },
    "transfer_human": {
      "type": "transfer",
      "transfer_config": {
        "department": "atendimento_geral",
        "priority": "normal",
        "context_summary": "{{conversation_summary}}",
        "estimated_wait": "5-10 minutos"
      },
      "message": {
        "text": "ğŸ‘¤ *Transferindo para Atendente Humano*\n\nVocÃª serÃ¡ conectado com um de nossos atendentes em breve.\n\nâ±ï¸ *Tempo estimado de espera:* 5-10 minutos\n\nğŸ“ *Resumo da conversa:* {{context_summary}}\n\nPor favor, aguarde...",
        "buttons": [
          {"id": "cancel_transfer", "title": "âŒ Cancelar"},
          {"id": "callback", "title": "ğŸ“ Solicitar Retorno"}
        ]
      },
      "transitions": {
        "cancel_transfer": "welcome",
        "callback": "schedule_callback",
        "agent_available": "human_chat",
        "timeout": "schedule_callback"
      }
    },
    "error": {
      "type": "message",
      "message": {
        "text": "âŒ *Ops! Algo deu errado*\n\nDesculpe, ocorreu um erro inesperado. Vamos tentar novamente?\n\nSe o problema persistir, vocÃª pode:\n- Falar com um atendente\n- Tentar mais tarde\n- Ligar para: *156*",
        "buttons": [
          {"id": "retry", "title": "ğŸ”„ Tentar Novamente"},
          {"id": "transfer", "title": "ğŸ‘¤ Atendente"},
          {"id": "menu", "title": "ğŸ“‹ Menu Principal"}
        ]
      },
      "transitions": {
        "retry": "welcome",
        "transfer": "transfer_human",
        "menu": "welcome",
        "default": "welcome"
      }
    }
  },
  "global_commands": {
    "menu": "welcome",
    "inÃ­cio": "welcome",
    "inicio": "welcome",
    "ajuda": "help",
    "help": "help",
    "sair": "goodbye",
    "tchau": "goodbye",
    "obrigado": "goodbye",
    "atendente": "transfer_human",
    "humano": "transfer_human"
  },
  "ai_config": {
    "default_model": "gpt-4",
    "fallback_model": "gpt-3.5-turbo",
    "temperature": 0.7,
    "max_tokens": 500,
    "timeout": 30,
    "retry_attempts": 3,
    "knowledge_base": {
      "name": "dibea_municipal_knowledge",
      "embedding_model": "text-embedding-ada-002",
      "similarity_threshold": 0.8,
      "max_context_length": 2000
    },
    "intent_classification": {
      "confidence_threshold": 0.7,
      "fallback_to_general": true
    }
  },
  "integrations": {
    "whatsapp": {
      "webhook_url": "/api/v1/whatsapp/webhook",
      "verify_token": "{{WHATSAPP_VERIFY_TOKEN}}",
      "access_token": "{{WHATSAPP_ACCESS_TOKEN}}",
      "phone_number_id": "{{WHATSAPP_PHONE_NUMBER_ID}}"
    },
    "api": {
      "base_url": "{{API_BASE_URL}}",
      "auth_header": "Authorization",
      "auth_token": "Bearer {{API_TOKEN}}",
      "timeout": 30
    },
    "storage": {
      "type": "redis",
      "connection": "{{REDIS_URL}}",
      "session_ttl": 3600,
      "context_ttl": 86400
    }
  },
  "analytics": {
    "track_events": [
      "conversation_start",
      "state_transition",
      "form_submission",
      "api_call",
      "ai_interaction",
      "human_transfer",
      "conversation_end"
    ],
    "metrics": [
      "response_time",
      "completion_rate",
      "satisfaction_score",
      "transfer_rate",
      "error_rate"
    ]
  }
}
